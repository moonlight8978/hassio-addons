vmType: vz
mountType: virtiofs
arch: aarch64

cpus: 2
memory: 2GiB
disk: 100GiB

images:
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release-20250115/ubuntu-24.04-server-cloudimg-amd64.img"
    arch: "x86_64"
    digest: "sha256:28d2f9df3ac0d24440eaf6998507df3405142cf94a55e1f90802c78e43d2d9df"
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release-20250115/ubuntu-24.04-server-cloudimg-arm64.img"
    arch: "aarch64"
    digest: "sha256:f11282a728ad42f8bfe0b646a6807674d79a019bfc229d80032345dd3228a2db"
  # Fallback to the latest release image.
  # Hint: run `limactl prune` to invalidate the cache
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-amd64.img"
    arch: "x86_64"
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-arm64.img"
    arch: "aarch64"

mounts:
  - location: "~/Workspace/moonlight8978/hassio-addons"
    mountPoint: "/usr/share/hassio/addons/local"
    writable: true
  - location: "/tmp/lima"
    writable: true

portForwards:
  - guestIPMustBeZero: true
    guestIP: 0.0.0.0
    guestPortRange:
      - 8123
      - 8200
    hostIP: 0.0.0.0
    hostPortRange:
      - 8123
      - 8200
    proto: tcp

networks:
  - lima: shared

provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail
      export DEBIAN_FRONTEND=noninteractive

      # Install docker
      curl -fsSL https://get.docker.com | sh

      # Install dependencies
      apt install \
        apparmor \
        bluez \
        cifs-utils \
        curl \
        dbus \
        jq \
        libglib2.0-bin \
        lsb-release \
        network-manager \
        nfs-common \
        systemd-journal-remote \
        systemd-resolved \
        udisks2 \
        wget -y

      # Install OS Agent
      curl -fsSL -o os-agent.deb https://github.com/home-assistant/os-agent/releases/download/1.6.0/os-agent_1.6.0_linux_aarch64.deb
      dpkg -i os-agent.deb

      # Install hassio supervised
      curl -fsSL -o supervised.deb https://github.com/home-assistant/supervised-installer/releases/latest/download/homeassistant-supervised.deb
      BYPASS_OS_CHECK=true MACHINE=raspberrypi3-64 dpkg -i supervised.deb
